<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Uma Rooma Fan Tracker</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #fafafa;
        color: #333;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    header {
        background: #222;
        color: #fff;
        padding: 1rem;
        width: 100%;
        text-align: center;
        font-size: 1.5rem;
        font-weight: bold;
    }
    main {
        max-width: 1000px;
        width: 100%;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    .controls {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    input[type="file"], button {
        padding: 0.5rem;
        font-size: 1rem;
        cursor: pointer;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
    }
    th, td {
        border: 1px solid #ccc;
        padding: 0.5rem;
        text-align: center;
    }
    th {
        background: #f4f4f4;
    }
    tr:hover {
        background: #f9f9f9;
    }
</style>
</head>
<body>

<header>Uma Rooma Fan Tracker</header>

<main>
    <div class="controls">
        <input type="file" id="jsonUpload" accept="application/json">
        <button onclick="fetchData()">Refresh Data</button>
    </div>
    
    <table id="dataTable">
        <thead>
            <tr>
                <th>Username</th>
                <th>Fan Count</th>
                <th>Scan Date</th>
                <th>Daily Δ</th>
                <th>Weekly Δ</th>
                <th>Monthly Δ</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</main>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwPfwQJGrCMar5q8elqvE07_kRrfhbjTK8yuTVHfo97GdFItPFq1YU_sN3C0PXxh5tDQQ/exec"; // from Google Apps Script

document.getElementById("jsonUpload").addEventListener("change", handleFileUpload);

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const jsonData = JSON.parse(e.target.result);
        // Send JSON to Google Sheets
        fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify({ action: "upload", data: jsonData })
        })
        .then(res => res.json())
        .then(data => {
            alert("Data uploaded successfully!");
            fetchData();
        })
        .catch(err => console.error(err));
    };
    reader.readAsText(file);
}

function fetchData() {
    fetch(SCRIPT_URL + "?action=read")
    .then(res => res.json())
    .then(data => {
        displayData(data);
    });
}

function displayData(data) {
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";

    data.forEach(row => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
            <td>${row.Username}</td>
            <td>${row.FanCount}</td>
            <td>${row.ScanDate}</td>
            <td>${row.DailyChange ?? "-"}</td>
            <td>${row.WeeklyChange ?? "-"}</td>
            <td>${row.MonthlyChange ?? "-"}</td>
            <td>
                <button onclick="deleteRow('${row.Username}', '${row.ScanDate}')">Delete</button>
            </td>
        `;

        tbody.appendChild(tr);
    });
}

function deleteRow(username, date) {
    if (!confirm(`Delete entry for ${username} on ${date}?`)) return;
    fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify({ action: "delete", username, date })
    })
    .then(res => res.json())
    .then(() => {
        fetchData();
    });
}

fetchData();
</script>

</body>
</html>
