<!DOCTYPE html>
<html>
<head>
  <title>Player Fan Count Tracker</title>
</head>
<body>
  <h1>Upload Player Data</h1>
  <input type="file" id="fileInput">
  <button onclick="uploadFile()">Upload</button>

  <h2>View Data</h2>
  <button onclick="fetchData()">Show All Data</button>
  <pre id="output"></pre>

  <h2>Stats</h2>
  <select id="period">
    <option value="day">Daily</option>
    <option value="week">Weekly</option>
    <option value="month">Monthly</option>
  </select>
  <input type="date" id="asOf">
  <button onclick="fetchStats()">Get Stats</button>
  <pre id="stats"></pre>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzFuioe_Vx3f2J0cjX-1Cab1YlGNoTLXmDI0P6toNTNHuKQC9L_onnWBYUSk7zI_HHh/exec"; // Replace

function uploadFile() {
  const file = document.getElementById('fileInput').files[0];
  if (!file) return alert("No file selected");

  const reader = new FileReader();
  reader.onload = function(e) {
    let text = e.target.result;
    let records;
    if (file.name.endsWith('.json')) {
      records = JSON.parse(text);
    } else if (file.name.endsWith('.tsv')) {
      let lines = text.trim().split("\n");
      let headers = lines[0].split("\t");
      records = lines.slice(1).map(line => {
        let values = line.split("\t");
        let obj = {};
        headers.forEach((h, i) => obj[h] = values[i]);
        return obj;
      });
    } else {
      return alert("Invalid file format");
    }

    fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'upload', records }),
    }).then(res => res.json())
      .then(data => alert("Upload complete"));
  }
  reader.readAsText(file);
}

function fetchData() {
  fetch(`${API_URL}?action=read`)
    .then(res => res.json())
    .then(data => {
      document.getElementById('output').textContent = JSON.stringify(data, null, 2);
    });
}

function fetchStats() {
  const period = document.getElementById('period').value;
  const asOf = document.getElementById('asOf').value;
  fetch(`${API_URL}?action=stats&period=${period}&asOf=${asOf}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById('stats').textContent = JSON.stringify(data, null, 2);
    });
}
</script>
</body>
</html>
